#!/usr/bin/env bash

printf "\x1b[1;32mStarting to apply custom osx settings.\n\e[0m"

# Mac OS X configuration
#
# This configuration applies to the latest version of macOS (currently 12.0),
# and sets up preferences and configurations for all the built-in services and
# apps. Third-party app config should be done elsewhere.
#
# Options:
#     --no-restart: Don't restart any apps or services after running the script.
#
# To get default settings before they are changed, do the following:
#
#     $ cd /tmp
#     $ defaults read > defaults.before
#     $ cat defaults.before
#
# @see https://git.herrbischoff.com/awesome-macos-command-line/about/
#

# Close any open System Preferences panes, to prevent them from overriding
# settings we’re about to change
osascript -e 'tell application "System Preferences" to quit'

# Ask for the administrator password upfront
sudo -v

# Username
USERNAME=$(whoami)

# Warn that some commands will not be run if the script is not run as root.
if [[ $EUID -ne 0 ]]; then
    RUN_AS_ROOT=false
    printf "\x1b[1;31mCertain commands will not be run without sudo privileges. To run as root, run the same command prepended with 'sudo', for example: $ sudo $0\n\n\e[0m" | fold -s -w 80
else
    RUN_AS_ROOT=true
    # Keep-alive: Update existing `sudo` timestamp until `.osx` has finished
    while true; do
        sudo -n true
        sleep 60
        kill -0 "$$" || exit
    done 2>/dev/null &
fi

###############################################################################
# General UI/UX                                                               #
###############################################################################

# Set computer name (as done via System Preferences → Sharing)
sudo scutil --set ComputerName "mbpro-${USERNAME}"
sudo scutil --set HostName "mbpro-${USERNAME}"
sudo scutil --set LocalHostName "mbpro-${USERNAME}"
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "mbpro-${USERNAME}"

# Disable the sound effects on boot
sudo nvram SystemAudioVolume=" "

# Expand save panel by default
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Expand print panel by default
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Automatically quit printer app once the print jobs complete
defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# Reveal IP address, hostname, OS version, etc. when clicking the clock
# in the login window (only).
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName

###############################################################################
### Keyboard
###############################################################################

### Keyboard

defaults write com.apple.keyboard.fnState -int 1

### Text

# Disable auto-correct
defaults write com.apple.notes NSAutomaticSpellingCorrectionEnabled -bool false

# Disable press-and-hold for keys in favor of key repeat
# defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Set a blazingly fast keyboard repeat rate, and make it happen more quickly.
# defaults write NSGlobalDomain InitialKeyRepeat -int 20
# defaults write NSGlobalDomain KeyRepeat -int 1

## Do not disable smart dashes, but set them as simple one's, instead of smart.
defaults write NSGlobalDomain NSUserQuotesArray -array '"\""' '"\""' '"'\''"' '"'\''"'

### Shortcuts
# ...

### Input Sources
# ...

### Dictation
# ...

###############################################################################
### Trackpad
###############################################################################

### Included in macbook is com.apple.AppleMultitouchTrackpad
### bluetooth trackpad would be com.apple.driver.AppleBluetoothMultitouch.trackpad

### Point and Click

defaults write NSGlobalDomain ContextMenuGesture -int 1

# Map bottom right corner to right-click for integrated trackpad (requires restart!)
defaults write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1
defaults write NSGlobalDomain com.apple.trackpad.enableSecondaryClick -bool true

# Map bottom right corner to right-click for bluetooth trackpad (requires restart!)
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true



###############################################################################
### Mouse
###############################################################################

# Disable natural scroll for mouse and trackpad
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false



###############################################################################
# Language and Region                                                         #
###############################################################################

# Set language and text formats
defaults write NSGlobalDomain AppleLanguages -array "en-US" "lv-LV" "ru-LV"
defaults write NSGlobalDomain AppleLocale -string "en_US@currency=EUR"
defaults write NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
defaults write NSGlobalDomain AppleMetricUnits -bool true

# Set the timezone; see `sudo systemsetup -listtimezones` for other values
sudo systemsetup -settimezone "Europe/Riga" >/dev/null 2>&1

# Add input sources - Latvian and Russian - Phonetic
defaults write com.apple.HIToolbox AppleEnabledInputSources -array-add '<dict><key>InputSourceKind</key><string>Keyboard Layout</string><key>KeyboardLayout ID</key><integer>19457</integer><key>KeyboardLayout Name</key><string>Russian - Phonetic</string></dict>'
defaults write com.apple.HIToolbox AppleEnabledInputSources -array-add '<dict><key>InputSourceKind</key><string>Keyboard Layout</string><key>KeyboardLayout ID</key><integer>30765</integer><key>KeyboardLayout Name</key><string>Latvian</string></dict>'

# Enables the input menu in the menu bar
defaults write com.apple.TextInputMenu visible -bool true



###############################################################################
# Energy Saving                                                               #
###############################################################################

# Restart automatically if the computer freezes
if [[ "$RUN_AS_ROOT" = true ]]; then
    sudo systemsetup -setrestartfreeze on
fi

# Sleep the display after 15 minutes
sudo pmset -a displaysleep 15

# Disable machine sleep while charging
sudo pmset -c sleep 0

# Set machine sleep to 5 minutes on battery
sudo pmset -b sleep 5

# You can set the amount of idle time in minutes that need to elapse before
# a Mac goes to sleep with the following syntax, in this example we’ll use 60
# meaning an hour of inactivity before the Mac sleeps
# sudo systemsetup -setcomputersleep 60
#
# How to Check Current Mac System Sleep Status
# sudo systemsetup -getcomputersleep
#
# Never go into computer sleep mode
sudo systemsetup -setcomputersleep Never >/dev/null



###############################################################################
# Screen                                                                      #
###############################################################################

# Require password immediately after sleep or screen saver begins
defaults write com.apple.screensaver askForPassword -int 1
defaults write com.apple.screensaver askForPasswordDelay -int 0



###############################################################################
# Finder                                                                      #
###############################################################################

# Allow quitting via ⌘ + Q; doing so will also hide desktop icons
defaults write com.apple.finder QuitMenuItem -bool true

# Set Desktop as the default location for new Finder windows
# For other paths, use `PfLo` and `file:///full/path/here/`
defaults write com.apple.finder NewWindowTarget -string "PfDe"
defaults write com.apple.finder NewWindowTargetPath -string "file://${HOME}/Desktop/"

# Show icons for hard drives, servers, and removable media on the desktop
# defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool true
# defaults write com.apple.finder ShowHardDrivesOnDesktop -bool true
# defaults write com.apple.finder ShowMountedServersOnDesktop -bool true
# defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true

# Use column view in all Finder windows by default
# Four-letter codes for the other view modes: `icnv`, `Nlsv`, `clmv`, `Flwv`
# defaults write com.apple.finder FXPreferredViewStyle -string "clmv"

# When performing a search, search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# Show path bar (Example: 751 items ... 351 GB left ...)
defaults write com.apple.finder ShowPathbar -bool true

# Keep folders on top when sorting by name
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# Disable the warning when changing a file extension
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Show status bar
defaults write com.apple.finder ShowStatusBar -bool true

# Show bottom path bar by default
defaults write com.apple.finder ShowPathBar -bool true

# Avoid creating .DS_Store files on network or USB volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Display full POSIX path as Finder window title
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# Show all filename extensions
# defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Show the ~/Library folder
chflags nohidden ~/Library && xattr -d com.apple.FinderInfo ~/Library

# Show the ~/Users folder
chflags nohidden /Users

# Expand the following File Info panes:
# "General", "Open with", and "Sharing & Permissions"
defaults write com.apple.finder FXInfoPanesExpanded -dict \
    MetaData -bool true \
    General -bool true \
    OpenWith -bool true \
    Privileges -bool true

# Disable the warning before emptying the Trash
defaults write com.apple.finder WarnOnEmptyTrash -bool false



###############################################################################
# Screenshots                                                                 #
###############################################################################

# Save screenshots to custom folder instead of Desktop.
defaults write com.apple.screencapture location -string "${HOME}/Screenshots"

# Change the default screenshot file name
defaults write com.apple.screencapture "name" -string "scr"



###############################################################################
# Safari                                                                      #
###############################################################################

# @todo Add to readme.md as post install instruction
# You will have to manually give full disk access to terminal/iterm to do that
# Enable Safari’s debug menu
# Go to System Preferences -> Security & Privacy -> Full Disk Access -> Click on iTerm2
# defaults write com.apple.Safari IncludeInternalDebugMenu -bool true

# Enable Develop menu and the Web Inspector in Safari 14+
defaults write com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true
defaults write com.apple.Safari WebKitPreferences.developerExtrasEnabled -bool true
defaults write com.apple.Safari UserStyleSheetEnabled -bool false

# Set default homepage - for me, it a super app.daily.dev
defaults write com.apple.Safari HomePage -string "https://app.daily.dev/"

# Show homepage instead of Start Page when opening new tab
defaults write com.apple.Safari NewTabBehavior -bool false

# Show homepage instead of Start Page when opening new window
defaults write com.apple.Safari NewWindowBehavior -bool false



###############################################################################
# Mail                                                                        #
###############################################################################

# Copy email addresses as `foo@example.com` instead of `Foo Bar <foo@example.com>` in Mail.app
defaults write com.apple.mail AddressesIncludeNameOnPasteboard -bool false



###############################################################################
# Address Book, Dashboard, iCal, TextEdit, and Disk Utility                   #
###############################################################################

# Use plain text mode for new TextEdit documents
defaults write com.apple.TextEdit RichText -int 0

# Open and save files as UTF-8 in TextEdit
defaults write com.apple.TextEdit PlainTextEncoding -int 4
defaults write com.apple.TextEdit PlainTextEncodingForWrite -int 4



###############################################################################
# Dock and Hot Corners                                                        #
###############################################################################

### Dock
### Some examples can be found here:
### https://macos-defaults.com

# Enable spring loading for all Dock items
# https://macos-defaults.com/misc/enable-spring-load-actions-on-all-items.html#set-to-false-default-value
defaults write com.apple.dock "enable-spring-load-actions-on-all-items" -bool "true"

# Don’t show recent applications in Dock
defaults write com.apple.dock "show-recents" -bool false

# Reset Launchpad, but keep the desktop wallpaper intact
find "${HOME}/Library/Application Support/Dock" -name "*-*.db" -maxdepth 1 -delete

# Add iOS & Watch Simulator to Launchpad
sudo ln -sf "/Applications/Xcode.app/Contents/Developer/Applications/Simulator.app" "/Applications/Simulator.app"
sudo ln -sf "/Applications/Xcode.app/Contents/Developer/Applications/Simulator (Watch).app" "/Applications/Simulator (Watch).app"

# Add a spacer to the left side of the Dock (where the applications are)
#defaults write com.apple.dock persistent-apps -array-add '{tile-data={}; tile-type="spacer-tile";}'
# Add a spacer to the right side of the Dock (where the Trash is)
#defaults write com.apple.dock persistent-others -array-add '{tile-data={}; tile-type="spacer-tile";}'

### Hot Corners

# Possible values:
#  0: no-op
#  2: Mission Control
#  3: Show application windows
#  4: Desktop
#  5: Start screen saver
#  6: Disable screen saver
#  7: Dashboard
# 10: Put display to sleep
# 11: Launchpad
# 12: Notification Center
# 13: Lock Screen

# Top left screen corner → Mission Control
# defaults write com.apple.dock wvous-tl-corner -int 2
# defaults write com.apple.dock wvous-tl-modifier -int 0

# Top right screen corner → Desktop
# defaults write com.apple.dock wvous-tr-corner -int 10
# defaults write com.apple.dock wvous-tr-modifier -int 0

# Bottom left screen corner → Start screen saver
defaults write com.apple.dock wvous-bl-corner -int 5
defaults write com.apple.dock wvous-bl-modifier -int 0

# Bottom right screen corner → Launchpad
defaults write com.apple.dock wvous-br-corner -int 11
defaults write com.apple.dock wvous-br-modifier -int 0



###############################################################################
# Photos                                                                      #
###############################################################################

# Prevent Photos from opening automatically when devices are plugged in
defaults write com.apple.ImageCapture disableHotPlug -bool true

###############################################################################
# Activity Monitor                                                            #
###############################################################################

# Show the main window when launching Activity Monitor
defaults write com.apple.ActivityMonitor OpenMainWindow -bool true

# Show all processes in Activity Monitor
defaults write com.apple.ActivityMonitor ShowCategory -int 0

# Sort Activity Monitor results by CPU usage
defaults write com.apple.ActivityMonitor SortColumn -string "CPUUsage"
defaults write com.apple.ActivityMonitor SortDirection -int 0



###############################################################################
# Feedback Assistant                                                          #
###############################################################################

### Autogather

defaults write com.apple.appleseed.FeedbackAssistant "Autogather" -bool "false"



###############################################################################
# Kill/restart affected applications                                          #
###############################################################################

# Restart affected applications if `--no-restart` flag is not present.
if [[ ! ($* == *--no-restart*) ]]; then
    for app in \
        "Activity Monitor" \
        "Address Book" \
        "Calendar" \
        "Contacts" \
        "cfprefsd" \
        "Dock" \
        "Finder" \
        "Mail" \
        "Messages" \
        "Safari" \
        "SystemUIServer" \
        "Terminal"; do
        killall "${app}" >/dev/null 2>&1
    done
fi

printf "\x1b[1;32mDone.\n\e[0m"
printf "\x1b[1;32mNote that some of these changes require a logout/restart to take effect.\n\e[0m"
